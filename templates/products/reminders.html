{% extends 'base.html' %}
{% load static %}

{% block title %}My Skincare Reminders - SkinSense{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-bell"></i> My Skincare Reminders</h2>
            <p class="text-muted">Never miss your skincare routine again!</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'add_reminder' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Reminder
            </a>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    {% if reminders %}
    <div class="row">
        {% for reminder in reminders %}
        <div class="col-md-6 mb-4">
            <div class="card h-100 {% if not reminder.is_active %}opacity-50{% endif %} reminder-card" 
                 data-reminder-id="{{ reminder.id }}"
                 data-reminder-title="{{ reminder.title }}"
                 data-reminder-time="{{ reminder.time|time:'H:i' }}"
                 data-reminder-active="{{ reminder.is_active }}"
                 data-reminder-frequency="{{ reminder.frequency }}"
                 data-reminder-monday="{{ reminder.monday }}"
                 data-reminder-tuesday="{{ reminder.tuesday }}"
                 data-reminder-wednesday="{{ reminder.wednesday }}"
                 data-reminder-thursday="{{ reminder.thursday }}"
                 data-reminder-friday="{{ reminder.friday }}"
                 data-reminder-saturday="{{ reminder.saturday }}"
                 data-reminder-sunday="{{ reminder.sunday }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title">
                            <i class="fas fa-clock text-primary"></i> {{ reminder.title }}
                        </h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input toggle-reminder" type="checkbox" 
                                   data-reminder-id="{{ reminder.id }}"
                                   data-toggle-url="{% url 'toggle_reminder' reminder.id %}"
                                   {% if reminder.is_active %}checked{% endif %}>
                            <label class="form-check-label">
                                {% if reminder.is_active %}Active{% else %}Inactive{% endif %}
                            </label>
                        </div>
                    </div>

                    <div class="reminder-details">
                        <p class="mb-2">
                            <strong><i class="fas fa-sun"></i> Type:</strong>
                            <span class="badge bg-info">{{ reminder.get_reminder_type_display }}</span>
                        </p>
                        <p class="mb-2">
                            <strong><i class="fas fa-clock"></i> Time:</strong>
                            {{ reminder.time|time:"g:i A" }}
                        </p>
                        <p class="mb-2">
                            <strong><i class="fas fa-calendar"></i> Frequency:</strong>
                            <span class="badge bg-success">{{ reminder.get_frequency_display }}</span>
                        </p>

                        {% if reminder.frequency == 'custom' %}
                        <p class="mb-2">
                            <strong><i class="fas fa-calendar-check"></i> Days:</strong>
                            {% if reminder.monday %}<span class="badge bg-secondary">Mon</span>{% endif %}
                            {% if reminder.tuesday %}<span class="badge bg-secondary">Tue</span>{% endif %}
                            {% if reminder.wednesday %}<span class="badge bg-secondary">Wed</span>{% endif %}
                            {% if reminder.thursday %}<span class="badge bg-secondary">Thu</span>{% endif %}
                            {% if reminder.friday %}<span class="badge bg-secondary">Fri</span>{% endif %}
                            {% if reminder.saturday %}<span class="badge bg-secondary">Sat</span>{% endif %}
                            {% if reminder.sunday %}<span class="badge bg-secondary">Sun</span>{% endif %}
                        </p>
                        {% endif %}

                        {% if reminder.notes %}
                        <p class="mb-2">
                            <strong><i class="fas fa-sticky-note"></i> Notes:</strong><br>
                            <small class="text-muted">{{ reminder.notes }}</small>
                        </p>
                        {% endif %}
                    </div>

                    <div class="mt-3 d-flex gap-2">
                        <a href="{% url 'edit_reminder' reminder.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="{% url 'delete_reminder' reminder.id %}" 
                           class="btn btn-sm btn-outline-danger"
                           onclick="return confirm('Are you sure you want to delete this reminder?')">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small>Created: {{ reminder.created_at|date:"M d, Y" }}</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-bell-slash fa-5x text-muted mb-4"></i>
        <h4>No Reminders Yet</h4>
        <p class="text-muted">Create your first skincare reminder to stay on track with your routine!</p>
        <a href="{% url 'add_reminder' %}" class="btn btn-primary mt-3">
            <i class="fas fa-plus"></i> Add Your First Reminder
        </a>
    </div>
    {% endif %}
</div>

<style>
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.form-check-input {
    cursor: pointer;
    width: 3em;
    height: 1.5em;
}

.reminder-details {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Request notification permission on page load
    if ('Notification' in window && Notification.permission === 'default') {
        showPermissionPrompt();
    }
    
    // Toggle reminder functionality
    document.querySelectorAll('.toggle-reminder').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const url = this.getAttribute('data-toggle-url');
            window.location.href = url;
        });
    });
    
    // Check active reminders and schedule notifications
    checkReminders();
    // Check every minute
    setInterval(checkReminders, 60000);
});

function showPermissionPrompt() {
    const banner = document.createElement('div');
    banner.className = 'alert alert-info alert-dismissible fade show';
    banner.style.cssText = 'margin-bottom: 20px;';
    banner.innerHTML = `
        <strong>üîî Enable Notifications</strong><br>
        Allow notifications to get reminders for your skincare routine!
        <button onclick="requestNotificationPermission()" class="btn btn-sm btn-primary ms-3">Enable Now</button>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(banner, document.querySelector('.row'));
}

function requestNotificationPermission() {
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            alert('‚úÖ Notifications enabled! You will receive reminders at the scheduled time.');
            document.querySelector('.alert-info')?.remove();
        }
    });
}

function checkReminders() {
    const reminderCards = document.querySelectorAll('.reminder-card[data-reminder-active="True"]');
    const now = new Date();
    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
    
    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDayName = dayNames[currentDay];
    
    reminderCards.forEach(card => {
        const reminderTime = card.getAttribute('data-reminder-time');
        const reminderTitle = card.getAttribute('data-reminder-title');
        const frequency = card.getAttribute('data-reminder-frequency');
        const reminderId = card.getAttribute('data-reminder-id');
        
        // Check if it's time for this reminder
        if (reminderTime === currentTime) {
            // Check if we should show notification based on frequency
            let shouldNotify = false;
            
            if (frequency === 'daily') {
                shouldNotify = true;
            } else if (frequency === 'weekdays') {
                // Monday to Friday (1-5)
                shouldNotify = currentDay >= 1 && currentDay <= 5;
            } else if (frequency === 'weekends') {
                // Saturday and Sunday (0, 6)
                shouldNotify = currentDay === 0 || currentDay === 6;
            } else if (frequency === 'custom') {
                // Check if today's day is selected
                const isDaySelected = card.getAttribute('data-reminder-' + currentDayName);
                shouldNotify = isDaySelected === 'True';
            }
            
            if (shouldNotify) {
                // Check if we already notified for this reminder today
                const notifiedKey = 'notified_' + reminderId + '_' + now.toDateString();
                if (!sessionStorage.getItem(notifiedKey)) {
                    showNotification(reminderTitle);
                    sessionStorage.setItem(notifiedKey, 'true');
                }
            }
        }
    });
}

function showNotification(reminderTitle) {
    // Check if notifications are supported and permitted
    if ('Notification' in window) {
        if (Notification.permission === 'granted') {
            const notification = new Notification('‚è∞ Skincare Reminder!', {
                body: reminderTitle,
                icon: 'https://cdn-icons-png.flaticon.com/512/3304/3304567.png',
                badge: 'https://cdn-icons-png.flaticon.com/512/3304/3304567.png',
                tag: 'skincare-reminder',
                requireInteraction: true,
                vibrate: [200, 100, 200]
            });
            
            notification.onclick = function() {
                window.focus();
                this.close();
            };
            
            // Auto close after 30 seconds
            setTimeout(() => notification.close(), 30000);
        } else if (Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showNotification(reminderTitle);
                }
            });
        }
    }
    
    // Also show browser alert as fallback
    if (Notification.permission !== 'granted') {
        playAlertSound();
        showAlertPopup(reminderTitle);
    }
}

function playAlertSound() {
    // Create audio context for notification sound
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
}

function showAlertPopup(reminderTitle) {
    // Create custom popup
    const popup = document.createElement('div');
    popup.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.5s ease-out;
    `;
    
    popup.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="font-size: 40px;">‚è∞</div>
            <div>
                <div style="font-weight: bold; font-size: 18px; margin-bottom: 8px;">Skincare Reminder!</div>
                <div style="font-size: 16px; opacity: 0.95;">${reminderTitle}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 5px 10px; 
                           border-radius: 50%; cursor: pointer; margin-left: auto; font-size: 18px; width: 35px; height: 35px;">‚úï</button>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Auto remove after 10 seconds
    setTimeout(() => {
        popup.style.animation = 'slideOut 0.5s ease-out';
        setTimeout(() => popup.remove(), 500);
    }, 10000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
